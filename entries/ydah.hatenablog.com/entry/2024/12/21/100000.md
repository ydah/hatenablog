---
Title: Raccに新しい文法が追加された話
Date: 2024-12-21T10:00:00+09:00
URL: https://ydah.hatenablog.com/entry/2024/12/21/100000
EditURL: https://blog.hatena.ne.jp/ydah/ydah.hatenablog.com/atom/entry/6802418398313518770
---

この記事は [Ruby AdventCalendar 2024](https://qiita.com/advent-calendar/2024/ruby) 21 日目の記事です。

みなさんこんにちは。@ydahです。
ほんじつは、今年あたらしく追加されたRaccの新文法についてお話しします。

## Raccとは


[https://github.com/ruby/racc:embed:cite]


Raccは[青木峰郎さん](https://github.com/aamine)によって作成された、文法規則からRubyで書かれた構文解析器を生成するパーサジェネレーターです。
パーサ生成のアルゴリズムには、[yacc](https://www.tuhs.org/cgi-bin/utree.pl?file=V6/usr/source/yacc)や[Lrama](https://github.com/ruby/lrama)などと同じLALR(1)[^1]を使用しています。

このRaccを使って構文解析器を作成している例としては、Lramaや[rdoc](https://github.com/ruby/rdoc)が挙げられます。

[^1]: LALR(1)はLook-Ahead LR(1)の略で、1つ先読みして決定するLR(1)パーサの一種です。

本記事では、Raccの使い方や基本的な文法については触れません。詳細は[Racc ユーザマニュアル](https://i.loveruby.net/ja/projects/racc/doc/)を参照してください。
もしくは最近だと俺たちの[金子さん](https://github.com/yui-knk)が作った[lr-parser-101](https://github.com/yui-knk/lr-parser-101)というRubyで書かれたLALR(1) パーサジェネレーター Raccを使った電卓の実装を通じて、パーサジェネレーターを利用したパーサの作り方について学ぶことができるチュートリアルもあります。Raccの使い方がわからないという方はぜひ見てみてください。

## 新文法の追加

2024年では以下のバージョンがリリースされました。

- Racc 1.8.0: https://github.com/ruby/racc/releases/tag/v1.8.0
- Racc 1.8.1: https://github.com/ruby/racc/releases/tag/v1.8.1

その中で、v1.8.0に含まれた以下のプルリクエストで新しい文法が追加されています。


[https://github.com/ruby/racc/pull/222:embed:cite]

このプルリクエストでは、Raccの文法に`?`、`*`、`+`などの正規表現のメタ文字[^2]のように使用可能な記法が追加されました。
また、グルーピングができるようになり、`()`で囲むことで文法ルール内で複数の要素をまとめる表現が可能になりました。

[^2]: https://docs.ruby-lang.org/ja/latest/doc/spec=2fregexp.html#metachar

これらの新文法は[ANTLR](https://www.antlr.org/)[^3]由来のものです。

[^3]: LL構文解析に基づくパーサージェネレーターで、LRのように見えるがANother Tool for Language Recognitionの略です。

## 使ってみましょう

まずは、グルーピングを使った例を見てみましょう。
たとえば、`a`または`b`または`c`のいずれかを取ることができる文法を考えてみます。
愚直に書くと以下のようになります。

```racc
class MyParser
rule
  abc: a
      | b
      | c
end
```

これをグルーピングを使って書き直すと、以下のようになります。

```racc
class MyParser
rule
  abc: (a | b | c)
end
```

このように、`()`で囲むことで複数の要素をまとめる表現が可能になりました。

続いて、`?`、`*`、`+`を使った例を見てみます。
これらは、それぞれ0回または1回、0回以上、1回以上の繰り返しを表します。要は正規表現の`?`、`*`、`+`と同時なので、正規表現を書くような感覚で文法を書くことができます。

たとえばですが、Rubyを書く場合に、[式と式の間はセミコロン`;`または改行で区切ります。](https://docs.ruby-lang.org/ja/latest/doc/spec=2fprogram.html)
つまり、文末のセミコロンは改行されている場合には省略可能です。

```command
ruby -e "puts 1;
puts 2 # <-- セミコロンの省略
puts 3;"
1
2
3
```

改行されているか否かまでを含めると、文法が複雑になるので、ここでは文末のセミコロンのみは省略可能として考えてみましょう。
このようなオプショナルなセミコロンを表現する文法を定義する場合には、以下のように書くことができます。

```racc
class MyParser
rule
  program: expr ';'
         | expr
end
```

programは式(`expr`)とセミコロン(`;`)もしくは式(`expr`)のいずれかで構成されるという文法です。
これを`?`を使って書き直すと、以下のようになります。

```racc
class MyParser
rule
  program: expr ';'?
end
```

では、他の例も見てみましょう。たとえば、メソッドの引数は0もしくは1個以上の引数を取ることができます。

```ruby
def arg0; end
def arg1(a); end
def arg2(a, b); end
def arg3(a, b, c); end
```

これは以下のように書くことができます。

```racc
class MyParser
rule
  args: # empty
      | arg
      | args ',' arg
end
```

これはargs(引数のリスト)は、空、引数1つ、カンマ区切りの引数リストのいずれかで構成されるという文法を表しています。
これをグルーピングと組み合わせて`*`を使って書き直すと、以下のようになります。

```racc
class MyParser
rule
  args: # empty
        | arg (',' arg)*
end
```

もしくは、グルーピングと組み合わせて`+`を使って書くこともできます。

```racc
class MyParser
rule
  args: # empty
      | arg
      | arg (',' arg)+
end
```

このように、`?`、`*`、`+`を使うことで、正規表現のような感覚で文法を書くことができます。

## 進化を続けるRacc

Raccは、文法規則からRubyで書かれた構文解析器を生成するためのパーサジェネレーターとして、現在も進化を続けています。
新しい文法機能の追加により、より表現力豊かな記法が可能となり、ユーザーにとって使いやすさが向上しています。

また、RaccはLramaのパーサーを生成するツールとしても利用されており、Rubyのパーサーを作成するツールチェーンの重要な一部を担っています。[^5]
Lrama自体がRubyのパーサーを生成する役割を果たしている一方で、その内部で使用されるパーサーはRaccによって生成されています。

このように、Raccは単に独立したツールとしてだけでなく、Rubyエコシステムの中で構文解析を支える基盤のような存在となっています。
これからもRaccはLramaの内部のパーサーを生成していくことでしょうし、それはつまりRubyの構文解析において重要な役割を果たし続けることだと思います。

著者は、Lramaの新文法について今年たくさん話してきました[^6]が、Raccもまた新しい文法が追加されたことを知っていただければと思い本記事を書きました。
それでは良いお年を！

[^4]: パーサージェネレーターもパーサーを持っていて、Lramaのパーサーは文法ファイルをRaccが変換して生成しています。
[^5]: 厳密には、[Ruby 3.4からはLramaではなくPrismがデフォルトのパーサーとして採用されています](https://bugs.ruby-lang.org/issues/20564)が、Lramaは引き続き利用可能です。
[^6]: 著者は[RubyKaigi 2024](https://rubykaigi.org/2024/presentations/ydah_.html#day2)や、[EuRuKo 2024](https://2024.euruko.org/speakers/yudai_takada)ではLramaの新文法についての発表をしました。
